version: "0.2"

env:
  variables:
    AWS_ACCOUNT_ID: "REPLACE_WITH_YOUR_ACCOUNT_ID"
    AWS_REGION: "us-east-1"

phases:
  install:
    runtime-versions:
      nodejs: 22
    commands:
      - aws --version
      - npm install --prefix lambda

  build:
    commands:
      - echo Building Docker image
      - docker build -t sales-dashboard-frontend .

      - echo Authenticating with ECR
      - |
        aws ecr get-login-password | docker login \
          --username AWS \
          --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

      - echo Tagging and pushing image to ECR
      - |
        docker tag sales-dashboard-frontend:latest ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/sales-dashboard-frontend:latest
        docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/sales-dashboard-frontend:latest

      - echo Packaging SAM template
      - mkdir -p dist
      - |
        aws cloudformation package \
          --template-file serverless.yaml \
          --s3-bucket $TEMPLATE_BUCKET \
          --output-template-file dist/serverless-packaged.yaml

      - echo Uploading CFN templates to S3
      - aws s3 cp dist/serverless-packaged.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp main-stack.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp vpc.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp iam.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp rds.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp alb.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp ecs.yaml s3://$TEMPLATE_BUCKET/
      - aws s3 cp ecr.yaml s3://$TEMPLATE_BUCKET/

  post_build:
    commands:
      - echo Deploying main CloudFormation stack
      - |
        aws cloudformation deploy \
          --stack-name lab-sales-dashboard \
          --template-file main-stack.yaml \
          --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
          --parameter-overrides \
            TemplateBucket=$TEMPLATE_BUCKET \
            LatestAmiId=$LATEST_AMI_ID
